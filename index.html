<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é£²é ˜æ½®æµ | å­¸ç”Ÿé£²æ–™å–œå¥½å¤§æ•¸æ“š</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>

    <style>
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            color: white; 
            font-family: "Microsoft JhengHei", sans-serif;
        }
        .glass-card { 
            background: rgba(255, 255, 255, 0.15); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            border-radius: 1.5rem; 
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .chart-container { position: relative; height: 320px; width: 100%; }
        /* æ»¾å‹•æ¢æ¨£å¼ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-6xl mx-auto text-center mb-12" data-aos="fade-down">
        <h1 class="text-4xl md:text-5xl font-black mb-4 flex justify-center items-center gap-3">
            ğŸ¥¤ å­¸ç”Ÿé£²æ–™å–œå¥½æ•¸æ“šåˆ†æ
        </h1>
        <div id="status-tag" class="inline-block px-4 py-1 rounded-full bg-green-500 text-sm font-bold shadow-lg">
            æ•¸æ“šåŒæ­¥ä¸­
        </div>
    </div>

    <div class="max-w-6xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
        
        <div class="glass-card p-8" data-aos="fade-right">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">ğŸ“Š å°±è®€å¹´ç´šåˆ†ä½ˆ</h3>
            <div class="chart-container">
                <canvas id="gradeChart"></canvas>
            </div>
        </div>

        <div class="glass-card p-8" data-aos="fade-left">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">ğŸ¹ æœ€å–œæ­¡çš„é£²å“é¡åˆ¥</h3>
            <div class="chart-container">
                <canvas id="drinkChart"></canvas>
            </div>
        </div>

        <div class="glass-card p-8 md:col-span-2" data-aos="fade-up">
            <h3 class="text-2xl font-bold mb-6 flex items-center gap-2">ğŸ“ ç¿’æ…£ç”œåº¦æ‘˜è¦ (å³æ™‚å›é¥‹)</h3>
            <div id="sugarList" class="flex flex-wrap gap-3">
                </div>
        </div>
    </div>

    <script>
        // Google è©¦ç®—è¡¨ç™¼å¸ƒçš„ CSV ç¶²å€ (åŠ ä¸Šæ™‚é–“æˆ³è¨˜é¿å…å¿«å–)
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTxj6-BEjCk5-VqEgMdY1q8YUZYQb2HKnB3l6ZViTVdKf1_RtUIrEqU7uxeXZhQ_PoormenvfhZ4r5b/pub?output=csv' + '&t=' + Date.now();

        async function initDashboard() {
            try {
                const response = await fetch(CSV_URL);
                if (!response.ok) throw new Error('ç„¡æ³•é€£ç·šè‡³æ•¸æ“šæº');
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => {
                        console.log("æˆåŠŸæŠ“å–è³‡æ–™:", results.data);
                        processAndRender(results.data);
                    }
                });
            } catch (error) {
                console.error(error);
                const tag = document.getElementById('status-tag');
                tag.innerText = "é€£ç·šå¤±æ•—ï¼š" + error.message;
                tag.classList.replace('bg-green-500', 'bg-red-500');
            }
        }

        function processAndRender(data) {
            const gradeCounts = {};
            const drinkCounts = {};
            const sugarTypes = [];

            // æ¨¡ç³Šæœå°‹æ¬„ä½åç¨±ï¼ˆè§£æ±ºæ¨™é¡Œé©šå˜†è™Ÿæˆ–ç·¨è™Ÿå•é¡Œï¼‰
            const keys = Object.keys(data[0]);
            const gradeKey = keys.find(k => k.includes('å¹´ç´š')) || '2. å°±è®€å¹´ç´š';
            const drinkKey = keys.find(k => k.includes('é£²å“é¡åˆ¥')) || '8. æœ€å–œæ­¡çš„é£²å“é¡åˆ¥ï¼';
            const sugarKey = keys.find(k => k.includes('ç”œåº¦')) || '9. ç¿’æ…£çš„ç”œåº¦';

            data.forEach(row => {
                // 1. å¹´ç´šçµ±è¨ˆ
                const g = row[gradeKey];
                if (g) gradeCounts[g] = (gradeCounts[g] || 0) + 1;

                // 2. é£²å“é¡åˆ¥çµ±è¨ˆ
                const d = row[drinkKey];
                if (d) drinkCounts[d] = (drinkCounts[d] || 0) + 1;

                // 3. ç”œåº¦æ¸…å–®
                if (row[sugarKey]) sugarTypes.push(row[sugarKey]);
            });

            renderGradeChart(gradeCounts);
            renderDrinkChart(drinkCounts);
            renderSugarTags(sugarTypes);

            // å•Ÿå‹• AOS å‹•ç•«
            AOS.init({ duration: 800, once: true });
        }

        function renderGradeChart(counts) {
            new Chart(document.getElementById('gradeChart'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        data: Object.values(counts),
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'],
                        hoverOffset: 15,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { color: 'white', font: { size: 14 } } }
                    }
                }
            });
        }

        function renderDrinkChart(counts) {
            new Chart(document.getElementById('drinkChart'), {
                type: 'bar',
                data: {
                    labels: Object.keys(counts),
                    datasets: [{
                        label: 'é¸æ“‡äººæ•¸',
                        data: Object.values(counts),
                        backgroundColor: 'rgba(255, 255, 255, 0.6)',
                        borderColor: '#ffffff',
                        borderWidth: 1,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: 'white' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { ticks: { color: 'white' }, grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function renderSugarTags(sugars) {
            const container = document.getElementById('sugarList');
            container.innerHTML = sugars.map(s => `
                <span class="px-4 py-2 bg-white/10 border border-white/20 rounded-lg text-sm hover:bg-white/20 transition-all cursor-default">
                    ${s}
                </span>
            `).join('');
        }

        // åˆå§‹åŒ–
        window.onload = initDashboard;
    </script>
</body>
</html>
